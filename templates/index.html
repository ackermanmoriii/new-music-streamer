<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Streamer</title>

    <style>
        body {
            background: #121212;
            color: #fff;
            margin: 0;
            font-family: Arial, sans-serif;
            padding-bottom: 120px;
        }
        header {
            padding: 20px;
            background: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 100;
            display:flex;
            gap:10px;
        }
        input {
            flex:1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #333;
            color: white;
        }
        button {
            padding: 12px 20px;
            background: #1db954;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: black;
            font-weight: bold;
        }
        .track-card {
            display: flex;
            background: #1e1e1e;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            gap: 15px;
        }
        .track-card img {
            width: 70px;
            height: 70px;
            border-radius: 6px;
        }
        .player-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #282828;
            padding: 10px;
            display: flex;
            align-items: center;
            border-top: 1px solid #444;
            transform: translateY(100%);
            transition: .3s;
            justify-content: space-between;
        }
        .player-bar.active {
            transform: translateY(0);
        }
        .play-btn {
            background: white;
            color: black;
            border-radius: 50%;
            font-size: 22px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>

<header>
    <input type="text" id="searchInput" placeholder="Search...">
    <button onclick="performSearch()">Go</button>
</header>

<div id="results"></div>

<div class="player-bar" id="playerBar">
    <div style="display:flex;align-items:center;gap:10px;">
        <img id="currentArt" src="" style="width:55px;height:55px;border-radius:6px;">
        <div>
            <div id="currentTitle" style="font-weight:bold;">Not Playing</div>
            <div id="currentArtist" style="font-size:13px;color:#ccc;">Select a song</div>
        </div>
    </div>

    <button class="play-btn" id="playPauseBtn" onclick="togglePlay()">▶</button>
</div>

<audio id="audioPlayer"></audio>

<script>
const audio = document.getElementById("audioPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const playerBar = document.getElementById("playerBar");


// ================================
// SEARCH
// ================================
async function performSearch() {
    const q = document.getElementById("searchInput").value.trim();
    if (!q) return;

    const resDiv = document.getElementById("results");
    resDiv.innerHTML = "<p style='text-align:center;color:#aaa;'>Loading...</p>";

    const r = await fetch(`/search?q=${encodeURIComponent(q)}`);
    const data = await r.json();

    if (!Array.isArray(data)) {
        resDiv.innerHTML = "<p style='text-align:center;color:red;'>Error</p>";
        return;
    }

    resDiv.innerHTML = "";
    data.forEach(track => {
        const card = document.createElement("div");
        card.className = "track-card";
        card.onclick = () => playTrack(track);

        card.innerHTML = `
            <img src="${track.thumbnail}">
            <div>
                <div style="font-weight:bold;">${track.title}</div>
                <div style="color:#ccc;font-size:13px;">${track.uploader}</div>
                <div style="color:#888;font-size:12px;">${track.duration}</div>
            </div>
        `;

        resDiv.appendChild(card);
    });
}


// ================================
// ** MOBILE-FIXED PLAY FUNCTION **
// ================================
async function playTrack(track) {
    document.getElementById("currentTitle").innerText = track.title;
    document.getElementById("currentArtist").innerText = track.uploader;
    document.getElementById("currentArt").src = track.thumbnail;

    playerBar.classList.add("active");
    playPauseBtn.innerText = "...";

    try {
        // 1. Get direct GoogleVideo URL
        const r = await fetch(`/direct?id=${track.id}`);
        const data = await r.json();

        if (!data.url) {
            alert("Could not get audio URL");
            playPauseBtn.innerText = "▶";
            return;
        }

        const realUrl = data.url;

        // 2. Fetch audio with REQUIRED HEADERS for mobile playback
        const response = await fetch(realUrl, {
            headers: {
                "User-Agent": navigator.userAgent,
                "Referer": "https://www.youtube.com/"
            }
        });

        // 3. Convert to Blob so mobile can play it
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        // 4. Play the blob
        audio.src = blobUrl;
        await audio.play();

        playPauseBtn.innerText = "⏸";

    } catch (err) {
        console.error("Playback error:", err);
        alert("Playback failed on mobile.");
        playPauseBtn.innerText = "▶";
    }
}


// ================================
// PLAY / PAUSE CONTROLS
// ================================
function togglePlay() {
    if (audio.paused) audio.play();
    else audio.pause();
}

audio.addEventListener("pause", () => playPauseBtn.innerText = "▶");
audio.addEventListener("play", () => playPauseBtn.innerText = "⏸");
</script>

</body>
</html>
